# Servers
## Monitoring: acct
(Note: cannot be used as a security tool, it's just a tool to get a bit more infos)\
Install from the [AUR](https://aur.archlinux.org/packages/acct/), then `sudo /usr/lib/acct/accton-create; sudo /usr/bin/accton on` to turn it on.\
Install `sudo pacman -S logrotate` to have log rotation. Defaults can be set in `/etc/logrotate.conf`. For acct, a configuration file has been created by the AUR at `/etc/logrotate.d/acct`, modify it if needed (but the default are good, one file per day with a monthly rotation and compression, maybe set default minsize and maxsize ?)

You can read [this guide](https://www.tecmint.com/how-to-monitor-user-activity-with-psacct-or-acct-tools/) to find usefull commands. Notable ones:\
● `ac -p`      --> total login time of each user in hours.\
● `ac -d hoel`   --> prints the day-wise total login time of user "hoel" in hours.\
● `sudo lastcomm kaan | head -20`   --> Shows the last 20 commands of user "kaan".\
● `sudo lastcomm rm | head -20`   --> Shows the last 20 times the command "rm" was used.

Note:\
Can also be downloaded from [GNU](https://www.gnu.org/software/acct/#downloading) and then installed manually with something like `./configure --prefix=/usr --sbindir=/usr/bin; make; sudo make install`. But it seems like the previous command is missing a few steps, see the AUR's [PKGBUILD](https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=acct) ans sources for details.

## Limits
Add the followings to `/etc/security/limits.conf` (details can be found on the [wiki](https://wiki.archlinux.org/title/Limits.conf) / in the file itself).

```
# Core
*           soft    core       0           # Prevent corefiles from being generated by default.
*           hard    core       unlimited   # Allow corefiles to be temporarily enabled.

# Nice
*           hard    nice       -19         # Prevent non-root users from running a process at minimal niceness.
root        hard    nice       -20         # Allows root to run a process at minimal niceness to fix the system when unresponsive.

# nproc
*           hard    nproc      2048        # Prevent fork-bombs from taking out the system.
root        hard    nproc      65536       # Prevent root from not being able to launch enough processes
```

## SSH
Install and enable it:
```
sudo pacman -S openssh
sudo systemctl enable sshd.service
sudo systemctl start sshd.service
```

## Sudoers
As root:
```
export EDITOR=/bin/vim
visudo
```
Then add a default editor (after all the other defaults):
```
Defaults    editor=/usr/bin/vim
```

To allow anyone to mount/unmount:
```
Cmnd_Alias MOUNT_CMDS = /usr/bin/mount, /usr/bin/umount
ALL ALL=NOPASSWD: MOUNT_CMDS
```

## Docker
### Disable cgroups v2
In `/etc/default/grub`, add systemd.unified_cgroup_hierarchy=false to the `GRUB_CMDLINE_LINUX_DEFAULT` list.\
Result should look like `GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet systemd.unified_cgroup_hierarchy=false"`\
Then re-generate the grub.cfg file with `grub-mkconfig -o /boot/grub/grub.cfg`.


Install the [nvidia-container-toolkit package](https://aur.archlinux.org/packages/nvidia-container-toolkit/) with `yay -S nvidia-container-toolkit`.\
Then in `/etc/nvidia-container-runtime/config.toml`, set `no-cgroups = false`.

Finally, restart the docker service. Test that docker containers can now use NVIDIA GPUs with `docker run --gpus all nvidia/cuda:11.3.0-runtime-ubuntu20.04 nvidia-smi`.
